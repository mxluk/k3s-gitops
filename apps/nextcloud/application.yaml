# File: apps/nextcloud/application.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nextcloud
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://nextcloud.github.io/helm
    chart: nextcloud
    targetRevision: 6.2.2
    helm:
      valuesObject:
        image:
          flavor: fpm-alpine
        
        ingress:
          enabled: true
          className: nginx
          annotations:
            nginx.ingress.kubernetes.io/proxy-body-size: "10G"
            nginx.ingress.kubernetes.io/proxy-buffering: "off"
            nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
          hosts:
            - nextcloud.mxluk.de
          tls: []
        
        nextcloud:
          host: nextcloud.mxluk.de
          username: admin
          password: changeme123!
          
          configs:
            proxy.config.php: |-
              <?php
              $CONFIG = array (
                'trusted_proxies' => array(
                  0 => '10.42.0.0/16',
                  1 => '10.0.0.0/16',
                ),
                'forwarded_for_headers' => array('HTTP_X_FORWARDED_FOR'),
                'overwriteprotocol' => 'https',
              );
        
        # Use Longhorn for persistent storage
        persistence:
          enabled: true
          storageClass: longhorn
          accessMode: ReadWriteOnce
          size: 10Gi
        
        # PostgreSQL database
        postgresql:
          enabled: true
          auth:
            username: nextcloud
            password: nextcloud123!
            database: nextcloud
          primary:
            persistence:
              enabled: true
              storageClass: longhorn
              size: 5Gi
        
        # Redis for caching
        redis:
          enabled: true
          auth:
            enabled: true
            password: redis123!
          master:
            persistence:
              enabled: true
              storageClass: longhorn
              size: 1Gi
        
        # Resources
        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            memory: 1Gi
        
        # Cronjobs for Nextcloud maintenance
        cronjob:
          enabled: true
  
  destination:
    server: https://kubernetes.default.svc
    namespace: nextcloud
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true